<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.m2m.mapper.ExtTopicFragmentMapper">
  <resultMap id="BaseResultMap" type="com.m2m.domain.TopicFragment">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 27 16:45:11 CST 2017.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="topic_id" jdbcType="BIGINT" property="topicId" />
    <result column="uid" jdbcType="BIGINT" property="uid" />
    <result column="fragment_image" jdbcType="VARCHAR" property="fragmentImage" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="content_type" jdbcType="INTEGER" property="contentType" />
    <result column="top_id" jdbcType="BIGINT" property="topId" />
    <result column="bottom_id" jdbcType="BIGINT" property="bottomId" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="at_uid" jdbcType="BIGINT" property="atUid" />
    <result column="source" jdbcType="INTEGER" property="source" />
    <result column="score" jdbcType="INTEGER" property="score" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="out_type" jdbcType="INTEGER" property="outType" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="com.m2m.domain.TopicFragmentWithBLOBs">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 27 16:45:11 CST 2017.
    -->
    <result column="fragment" jdbcType="LONGVARCHAR" property="fragment" />
    <result column="extra" jdbcType="LONGVARCHAR" property="extra" />
  </resultMap>

	<select id="getLastFragmentByTopicIds" resultMap="ResultMapWithBLOBs">
		select f2.* from topic_fragment f2,(select max(f.id) as fid
		from
		topic_fragment f where f.topic_id in
		<if test="idList!=null and idList.size() &gt; 0">
			<foreach close=")" collection="idList" item="ids" open="(" separator=",">
				#{ids}
			</foreach>
		</if>
		group by f.topic_id) m where f2.id=m.fid
	</select>
	
	<select id="countFragmentByTopicIdWithSince" resultType="com.m2m.entity.ExtFragmentUpdateCount">
    	select 	count(1) totalRecords,
    			count(if(f.id&gt;#{sinceId},TRUE,NULL)) as updateRecords,
    			max(f.id) as lastFragmentId,
    			count(if(f.id&lt;m.firstNormalFragmentId,TRUE,NULL)) as firstDelCount
    	from topic_fragment f,(
        	select 	f2.topic_id,
        			min(if(f2.status=1,f2.id,NULL)) as firstNormalFragmentId
        	from topic_fragment f2
        	where f2.topic_id=#{topicId}
    	) m
    	where f.topic_id=m.topic_id 
    	and f.topic_id=#{topicId}
  </select>
</mapper>
